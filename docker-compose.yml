services:
  # ---------------------------------------------------------------------------
  # INFRASTRUCTURE
  # ---------------------------------------------------------------------------
  
  # Vector Database - Qdrant
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ong_qdrant
    ports:
      - "6333:6333" # REST API
      - "6334:6334" # gRPC
    volumes:
      - qdrant_data:/qdrant/storage:z
    networks:
      - ong_network

  # Message Queue - Redpanda (Updated Image)
  redpanda:
    image: redpandadata/redpanda:latest  # <--- CHANGED THIS
    container_name: ong_redpanda
    command:
      - redpanda start
      - --smp 1  
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --node-id 0
      - --check=false
      - --kafka-addr PLAIN://0.0.0.0:9092,OUTSIDE://0.0.0.0:9094
      - --advertise-kafka-addr PLAIN://redpanda:9092,OUTSIDE://localhost:9094
    ports:
      - "9092:9092"
      - "9094:9094"
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    networks:
      - ong_network

  # Message Queue UI - Redpanda Console (Updated Image)
  redpanda-console:
    image: redpandadata/console:latest  # <--- CHANGED THIS
    container_name: ong_console
    ports:
      - "8080:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
    depends_on:
      - redpanda
    networks:
      - ong_network

  # Cache - Redis
  redis:
    image: redis:alpine
    container_name: ong_redis
    ports:
      - "6379:6379"
    networks:
      - ong_network

  # ---------------------------------------------------------------------------
  # MICROSERVICES
  # ---------------------------------------------------------------------------

  # Service 1: Ingestion
  ingestion-service:
    build:
      context: ./services/ingestion-service
      dockerfile: Dockerfile
    container_name: ong_ingestion
    volumes:
      - ./services/ingestion-service/src:/app/src
      - ./shared:/app/shared
      - ./data:/app/data
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - redpanda
      - qdrant
    networks:
      - ong_network
    command: ["tail", "-f", "/dev/null"] 

  # Service 2: Query API
  query-service:
    build:
      context: ./services/query-service
      dockerfile: Dockerfile
    container_name: ong_query
    ports:
      - "8000:8000"
    volumes:
      - ./services/query-service/src:/app/src
      - ./shared:/app/shared
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=redis://redis:6379
    depends_on:
      - qdrant
      - redis
    networks:
      - ong_network
    command: ["tail", "-f", "/dev/null"] 

networks:
  ong_network:
    driver: bridge

volumes:
  qdrant_data:
  redpanda_data: